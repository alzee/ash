#!/bin/bash
#
# vim:ft=bash

set -euo pipefail

############### Variables ###############

#tools=$(declare -F | awk '/install_/{sub(/.*install_/, ""); print $1}' | xargs)
tools=$(grep -oP '^install_\K\w+' "$0" | xargs)

############### Functions ###############

install_composer(){
    if [ ! -x ~/.local/bin/composer ];then
        echo Installing composer...
        local a=composer-setup.php
        curl -L https://getcomposer.org/installer -o "$a"
        # TODO not return
        if echo -n "$(curl -s https://composer.github.io/installer.sig) $a" | sha384sum -c --status;then
            php "$a" && rm "$a"
            mkdir ~/.local/bin -p
            mv composer.phar ~/.local/bin/composer
        else
            echo checksum fail!
        fi
    fi
}

install_symfony(){
    curl -sS https://get.symfony.com/cli/installer | bash
    ln -sf ../../.symfony5/bin/symfony ~/.local/bin/
}

install_deno(){
    curl -fsSL https://deno.land/install.sh | sh
    ln -sf ../../.deno/bin/deno ~/.local/bin/
}

install_rust(){
    curl --proto '=https' --tlsv1.3 https://sh.rustup.rs -sSf | sh
    echo Generating tab-completion scripts for your shell.
    mkdir -p ~/.local/share/bash-completion/completions/
    rustup completions bash >> ~/.local/share/bash-completion/completions/rustup
    rustup completions bash cargo >> ~/.local/share/bash-completion/completions/cargo
    rustup component add rust-analyzer
}

install_zed(){
    curl -f https://zed.dev/install.sh | sh
}

install_uv(){
    curl -LsSf https://astral.sh/uv/install.sh | sh
}

install_fastapi(){
    uv add fastapi --extra standard
}

install_nvm(){
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
    nvm install node
    nvm alias default node
}

install_fnm(){
    curl -fsSL https://fnm.vercel.app/install | bash
    . ~/.bashrc
    fnm i --latest
    #corepack enable yarn
    #corepack enable pnpm
}

install_angular(){
    npm install -g @angular/cli
}

install_ollama(){
    curl -fsSL https://ollama.com/install.sh | sh
}

install_huggingface(){
    curl -LsSf https://hf.co/cli/install.sh | bash
    # uv tool install huggingface_hub
}

install_claude(){
    curl -fsSL https://claude.ai/install.sh | bash
    #npm install -g @anthropic-ai/claude-code
}

install_cursor(){
    curl https://cursor.com/install -fsS | bash
    ln -sf cursor-agent ~/.local/bin/cursor
}

install_codex(){
    npm i -g @openai/codex
}

install_copilot(){
    curl -fsSL https://gh.io/copilot-install | bash
    # npm install -g @github/copilot
}

install_gemini(){
    npm install -g @google/gemini-cli
}

install_taro(){
    npm install -g @tarojs/cli
}

install_vim_gnupg(){
    git clone https://github.com/jamessan/vim-gnupg ~/w/vim-gnupg
    mkdir -p ~/.vim/pack/gnupg/start/
    ln -s ~/w/vim-gnupg ~/.vim/pack/gnupg/start/
}

_install(){
    if [ -z "$1" ]; then
        echo "Error: No tool specified"
        _help
        return 1
    fi
    if declare -f "install_$1" > /dev/null; then
        install_"$1"
    else
        echo "Error: Unknown tool '$1'"
        echo "Available tools: $tools"
        return 1
    fi
}

_uninstall(){
    :
}

_help(){
    echo 'Usage: tool i <tool_name>'
    echo tools supported:
    echo $tools
}

############### Main Part ###############

case ${1:-} in
    i)
        _install "${2:-}"
        ;;
    u)
        _uninstall "${2:-}"
        ;;
    l|list)
        echo "Available tools:"
        for tool in $tools; do
            echo "  - $tool"
        done
        ;;
    *)
        _help
        ;;
esac
