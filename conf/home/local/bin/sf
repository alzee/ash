#!/bin/bash
#
# vim:ft=sh

############### Variables ###############

boilerplates_dir=~/w/boilerplates

############### Functions ###############

new(){
    local pkgs i opt project
    project="$1"
    pkgs="admin
    vich/uploader-bundle
    symfony/ux-chartjs
    overtrue/pinyin
    phpoffice/phpspreadsheet
    --dev orm-fixtures"
    # friendsofsymfony/ckeditor-bundle
    symfony new --webapp "$project"

    if [ $? -gt 0 ]; then
        exit
    fi

    cd "$1"

    cp .env .env.local
    sed -i '/^#/d' .env.local
    sed -i "/^DATABASE_URL/s/app/$project/g; /^DATABASE/s/\!ChangeMe\!/$project/g" .env.local
    echo -e '\n*** Create database user'
    sudo -u postgres psql -c "create role $project with login createdb password '$project'"
    bin/console doc:data:create

    for i in $pkgs
    do
        if [ "$i" = --dev ]; then
            opt="$i"
            continue
        fi
        echo -e '\n*** Installing:' "$opt" "$i"
        composer req $opt "$i"
        git add -A; git commit -m "$i"
        unset opt
    done

    echo -e '\n*** Create Admin Dashboard'
    bin/console make:admin:dashboard
    ln -s src/Controller/Admin/ admin
    git add -A; git commit -m "admin dashboard"

    echo -e '\n*** Init mdbook'
    mdbook init docs
    ln -s ../docs/book/ public/docs
    git add -A; git commit -m "docs"

    echo -e '\n*** Make user'
    bin/console make:user
    bin/console make:migration
    git add -A; git commit -m "entity User"

    echo -e '\n*** Copy boilerplates...'
    for i in $(find $boilerplates_dir/symfony/ -type f -printf '%P\n')
    do
        mkdir -p $(dirname $i)
        ln -f $boilerplates_dir/symfony/$i $i
    done
    echo -e '\n*** Boilerplates copied.'
    echo DO review, remove files that you don\'t need.
}

############### Main Part ###############

case "$1" in
    s)
        symfony serve -d --allow-all-ip --allow-http
        sudo systemctl restart redis
        ;;
    S)
        symfony serve:stop
        ;;
    n|new)
        new "$2"
        ;;
    *)
        symfony "$@"
        ;;
esac
