#!/bin/bash
#
# vim:ft=sh

############### Variables ###############

############### Functions ###############

############### Main Part ###############

server=$WIN_IP
share=w
mountpoint=/mnt/w
# options="guest,user=guest,uid=1000"
options="user=al,uid=1000,password=s"
domain=win

if [ "$1" = "" ]; then
    echo 'win [up | down]'
fi

if [ "$1" = "up" ]; then
    virsh start $domain
    virt-manager -c 'qemu:///system' --show-domain-console $domain &

    echo "Waiting for Windows VM network..."

    # Wait for ping
    until ping -c1 -W1 "$server" >/dev/null 2>&1; do
        sleep 1
    done

    echo "Host is pingable. Waiting for SMB port 445..."

    # Wait for SMB port to be open
    while ! nc -z "$server" 445; do
        sleep 1
    done

    echo "Windows is ready. Mounting share..."
    sudo mount.cifs //$server/$share $mountpoint -o $options
fi

if [ "$1" = "down" ]; then
    echo umount win share...
    sudo umount $mountpoint

    echo shutting down win... 
    virsh shutdown $domain

    pkill virt-manager
fi
