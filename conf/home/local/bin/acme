#!/bin/bash
# vim:ft=bash

# Wrap acme.sh to simplify common usage

set -e

############### Functions ###############
help_msg(){
    echo test help
    exit
}

issue_cert() {
    local server wwwroot zone_list mode mode_param
    server=${server:-zerossl}

    for z in $zones
    do
        zone_list+=" -d $z"
    done

    case $mode in
        wwwroot)
            local z wwwroot
            mode_param="-w $wwwroot"
            ;;
        dns_alias)
            local zone_alias provider
            provider=${provider:-cf} # default cloudflare
            mode_param="--dns dns_$provider --challenge-alias $zone_alias"
            ;;
        dns_manual)
            mode_param="--dns --yes-I-know-dns-manual-mode-enough-go-ahead-please"
            ;;
        dns|*)
            local provider
            provider=${provider:-cf} # default cloudflare
            # zone_list="-d $zone -d '*.'$zone"
            mode_param="--dns dns_$provider"
            ;;
    esac

    $acme --issue $zone_list --server $server $mode_param
}

install_cert() {
    local certdir cmd
    certdir=${2:-~/cert}
    cmd="sudo service apache2 force-reload"
    mkdir -p $certdir
    $acme --install-cert -d "$zone" --key-file $certdir/$zone.key --cert-file $certdir/$zone.cer --fullchain-file $certdir/$zone.fullchain.cer --reloadcmd "$cmd"
}

renew_cert() {
    $acme --renew -d "$zone"
    # $acme --renew -d "$zone" --yes-I-know-dns-manual-mode-enough-go-ahead-please
}

remove_cert() {
    $acme --remove -d "$zone"
}

install_acme() {
    local email
    email=$1

    if [ -z $email ]; then
        echo 'acme get <email>'
        exit
    fi

    curl https://get.acme.sh | sh -s email=$email

    # wget -O -  https://get.acme.sh | sh -s email=$email

    # git clone https://github.com/acmesh-official/acme.sh.git
    # cd ./acme.sh
    # ./acme.sh --install -m $email
}

############### Variables ###############
zone="$1"
acme=~/.acme.sh/acme.sh

############### Main Part ###############
# if [ ! -f "$acme" ]; then
#     echo -e $acme: Not found, to install it, run: acme get '<email>'
#     exit
# fi

[ -z "$1" ] && help_msg

case $1 in
    get)
        install_acme $2
        ;;
    install)
        install_cert
        ;;
    issue)
        issue_cert
        ;;
    renew)
        renew_cert
        ;;
    rm|remove)
        remove_cert
        ;;
    upgrade)
        $acme --upgrade
        ;;
    autoupgrade)
        $acme --upgrade --auto-upgrade
        ;;
    info)
        $acme --info
        ;;
    l|list)
        $acme --list
        ;;
    h|help)
        $acme --help | less
        ;;
    *)
        $acme "$@"
        ;;
esac
