#!/bin/bash
# vim:ft=bash

# Wrap acme.sh to simplify common usage

set -e

zones=()
############### Functions ###############
help_msg(){
    echo test help
    exit
}

issue_cert() {
    local server wwwroot mode mode_param
    server=${server:-zerossl}

    case $mode in
        wwwroot)
            local z wwwroot
            mode_param="-w $wwwroot"
            ;;
        dns_alias)
            local zone_alias provider
            provider=${provider:-cf} # default cloudflare
            mode_param="--dns dns_$provider --challenge-alias $zone_alias"
            ;;
        dns_manual)
            mode_param="--dns --yes-I-know-dns-manual-mode-enough-go-ahead-please"
            ;;
        dns|*)
            local provider
            provider=${provider:-cf} # default cloudflare
            mode_param="--dns dns_$provider"
            ;;
    esac

    $acme --issue $zone_opts --server $server $mode_param
}

install_cert() {
    local certdir cmd zone
    zone="$1"
    certdir=${2:-~/cert}
    cmd="sudo service apache2 force-reload"
    mkdir -p $certdir
    $acme --install-cert -d "$zone" --key-file $certdir/$zone.key --cert-file $certdir/$zone.cer --fullchain-file $certdir/$zone.fullchain.cer --reloadcmd "$cmd"
}

renew_cert() {
    local zone
    zone="$1"
    $acme --renew -d "$zone"
    # $acme --renew -d "$zone" --yes-I-know-dns-manual-mode-enough-go-ahead-please
}

remove_cert() {
    local zone
    zone="$1"
    $acme --remove -d "$zone"
}

install_acme() {
    local email
    email=$1

    if [ -z $email ]; then
        echo 'acme get <email>'
        exit
    fi

    curl https://get.acme.sh | sh -s email=$email

    # wget -O -  https://get.acme.sh | sh -s email=$email

    # git clone https://github.com/acmesh-official/acme.sh.git
    # cd ./acme.sh
    # ./acme.sh --install -m $email
}

############### Variables ###############
acme=~/.acme.sh/acme.sh

############### Main Part ###############
# if [ ! -f "$acme" ]; then
#     echo -e $acme: Not found, to install it, run: acme get '<email>'
#     exit
# fi

[ -z "$1" ] && help_msg

opts=$(getopt -o d: -- "$@")
eval set -- "$opts"
zone_opts=${opts% --*}

while :; do
    case $1 in
        -d)
            zones+=("$2")
            shift
            ;;
        get)
            install_acme "$2"
            ;;
        install)
            install_cert "${zones[0]}"
            ;;
        issue)
            issue_cert "${zones[@]}"
            ;;
        renew)
            renew_cert "${zones[0]}"
            ;;
        rm|remove)
            remove_cert "${zones[0]}"
            ;;
        upgrade)
            $acme --upgrade
            ;;
        autoupgrade)
            $acme --upgrade --auto-upgrade
            ;;
        info)
            $acme --info
            ;;
        l|list)
            $acme --list
            ;;
        h|help)
            $acme --help | less
            ;;
        --)
            :
            ;;
        *)
            # $acme "$@"
            break
            ;;
    esac

    shift
done
